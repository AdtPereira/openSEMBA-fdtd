name: ubuntu-nvhpc

permissions:
  actions: write

on:
  push:
    branches:
      - main
      - dev
  pull_request:
    branches:
      - main
      - dev

jobs:
  builds-and-test:
    runs-on: ubuntu-latest

    strategy:
      matrix: 
        optimization-type: ["Debug", "Release"]
        # mpi-build: ["No", "Yes"]

    timeout-minutes: 30
    steps:       
    - name: Checkout
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    # - name: Setup ninja
    #   uses: seanmiddleditch/gha-setup-ninja@master

    - name: Install nvhpc compilers.
      run: |       
        echo "deb [trusted=yes] https://developer.download.nvidia.com/hpc-sdk/ubuntu/amd64 /" | sudo tee /etc/apt/sources.list.d/nvhpc.list
        sudo apt update
        sudo apt install -y nvhpc
        sudo apt clean
        
        NVCC="$(find /opt/*nvidia* -type f -executable -name nvcc -print | tail -1)"
        NVCXX="$(find /opt/*nvidia* -type f -executable -name nvc++ -print | tail -1)"
        NVFORTRAN="$(find /opt/*nvidia* -type f -executable -name nvfortran -print | tail -1)"
        
        # MPI_NVCC="$(find /opt/*nvidia* -type f -executable -name mpicc -print | tail -1)"
        # MPI_NVCXX="$(find /opt/*nvidia* -type f -executable -name mpic++ -print | tail -1)"
        # MPI_NVFORTRAN="$(find /opt/*nvidia* -type f -executable -name mpifort -print | tail -1)"
        
        sudo ln -s "$NVCC" /usr/bin
        sudo ln -s "$NVCXX" /usr/bin
        sudo ln -s "$NVFORTRAN" /usr/bin

        # sudo ln -s "$MPI_NVCC" /usr/bin
        # sudo ln -s "$MPI_NVCXX" /usr/bin
        # sudo ln -s "$MPI_NVFORTRAN" /usr/bin

      
    - name: Build application
      run: |
        export CC=nvcc
        export CXX=nvc++
        export FC=nvfortran
        cmake -S . -B build -DCMAKE_BUILD_TYPE=${{matrix.optimization-type}} -DCompileWithHDF=NO -DCompileWithMPI=NO
        cmake --build build -j
      
    - name: Run fdtd unit tests 
      timeout-minutes: 10 
      run: |
        build/bin/fdtd_tests

    - name: Install python wrapper requirements
      run: |
        python -m pip install -r requirements.txt

    - name: Run wrapper tests
      timeout-minutes: 30 
      run: |
        python -m pytest test
       
      